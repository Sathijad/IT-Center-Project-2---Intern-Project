name: Leave & Attendance CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'leave-attendance-backend/**'
      - '.github/workflows/leave-attendance-ci-cd.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'leave-attendance-backend/**'

env:
  AWS_REGION: ap-southeast-2
  NODE_VERSION: '20.x'

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: leave-attendance-backend/package-lock.json
      
      - name: Install dependencies
        working-directory: leave-attendance-backend
        run: npm ci
      
      - name: Run linter
        working-directory: leave-attendance-backend
        run: npm run lint || echo "Linter warnings (non-blocking)"
      
      - name: Run unit tests
        working-directory: leave-attendance-backend
        run: npm test -- --coverage --coverageReporters=text --coverageReporters=lcov
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: leave-attendance-backend/coverage/lcov.info
          flags: leave-attendance-backend
          name: leave-attendance-backend
      
      - name: SAST Scan
        uses: github/super-linter@v4
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_JAVASCRIPT_ES: true
          VALIDATE_JSON: true
          VALIDATE_YAML: true
      
      - name: SCA Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
          working-directory: leave-attendance-backend

  security-scan:
    name: Security Scan (ZAP)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'https://api-dev.itcenter.com/v2'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
      
      - name: Upload ZAP results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: zap-results
          path: report_html.html

  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.ref == 'refs/heads/develop'
    environment:
      name: dev
      url: https://api-dev.itcenter.com/v2
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2
      
      - name: SAM Build
        working-directory: leave-attendance-backend
        run: sam build
      
      - name: SAM Deploy (DEV)
        working-directory: leave-attendance-backend
        run: |
          sam deploy \
            --config-env dev \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --stack-name leave-attendance-dev
      
      - name: Setup Observability
        working-directory: leave-attendance-backend
        run: |
          chmod +x scripts/setup-observability.sh
          ./scripts/setup-observability.sh dev || echo "Observability setup failed (non-blocking)"

  deploy-stg:
    name: Deploy to STG
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: github.ref == 'refs/heads/main'
    environment:
      name: stg
      url: https://api-stg.itcenter.com/v2
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2
      
      - name: SAM Build
        working-directory: leave-attendance-backend
        run: sam build
      
      - name: SAM Deploy (STG)
        working-directory: leave-attendance-backend
        run: |
          sam deploy \
            --config-env stg \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --stack-name leave-attendance-stg
      
      - name: Setup Observability
        working-directory: leave-attendance-backend
        run: |
          chmod +x scripts/setup-observability.sh
          ./scripts/setup-observability.sh stg || echo "Observability setup failed (non-blocking)"

  deploy-prd:
    name: Deploy to PRD (Canary)
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: prd
      url: https://api.itcenter.com/v2
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2
      
      - name: SAM Build
        working-directory: leave-attendance-backend
        run: sam build
      
      - name: SAM Deploy (PRD - Canary 10%)
        working-directory: leave-attendance-backend
        run: |
          sam deploy \
            --config-env prd \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --stack-name leave-attendance-prd \
            --parameter-overrides CanaryPercentage=10
      
      - name: Wait for canary validation (2 hours)
        run: |
          echo "Canary deployment active. Monitor for 2 hours before full rollout."
          echo "If metrics are acceptable, trigger full deployment manually."
      
      - name: Setup Observability
        working-directory: leave-attendance-backend
        run: |
          chmod +x scripts/setup-observability.sh
          ./scripts/setup-observability.sh prd || echo "Observability setup failed (non-blocking)"

