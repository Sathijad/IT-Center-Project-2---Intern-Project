service: leave-attendance-api
frameworkVersion: '3'

plugins:
  - serverless-plugin-tracing
  - serverless-prune-plugin
  - serverless-esbuild

custom:
  stage: ${opt:stage, 'dev'}
  env: ${file(./config/env.${self:custom.stage}.yml)}
  prune:
    automatic: true
    number: 3
  esbuild:
    bundle: true
    minify: true
    platform: node
    target: node18
    sourcemap: false
    exclude: []
    keepOutputDirectory: true
  functionOverrides: ${file(./config/function-overrides.${self:provider.stage}.yml)}

provider:
  name: aws
  runtime: nodejs18.x
  region: ${opt:region, 'ap-southeast-2'}
  stage: ${self:custom.stage}
  logRetentionInDays: 30
  versionFunctions: true
  architecture: arm64
  lambdaHashingVersion: 20201221
  timeout: 30
  memorySize: 512
  environment:
    NODE_OPTIONS: '--enable-source-maps'
    NODE_ENV: ${self:provider.stage}
    TZ: 'UTC'
    DB_SECRET_ARN: ${self:custom.env.dbSecretArn}
    DB_PROXY_ENDPOINT: ${self:custom.env.dbProxyEndpoint}
    DB_POOL_MAX: ${self:custom.env.dbPoolMax, 10}
    COGNITO_REGION: ${self:custom.env.cognito.region}
    COGNITO_USER_POOL_ID: ${self:custom.env.cognito.userPoolId}
    COGNITO_CLIENT_ID: ${self:custom.env.cognito.clientId}
    GEO_VALIDATION_ENABLED: '${self:custom.env.featureFlags.geoValidationEnabled}'
    CALENDAR_SYNC_ENABLED: '${self:custom.env.featureFlags.calendarSyncEnabled}'
    # CALENDAR_SYNC_ENABLED: 'false'  
    GRAPH_TENANT: ${self:custom.env.graph.tenant}
    GRAPH_CLIENT_ID: ${self:custom.env.graph.clientId}
    GRAPH_CLIENT_SECRET: ${self:custom.env.graph.clientSecret}
    GRAPH_SCOPE: ${self:custom.env.graph.scope}
    ALLOWED_ORIGINS:
      Fn::Join:
        - ','
        - ${self:custom.env.allowedOrigins}
    CALENDAR_SYNC_QUEUE_URL: { Ref: CalendarSyncQueue }
    CALENDAR_SYNC_QUEUE_ARN: { 'Fn::GetAtt': [CalendarSyncQueue, Arn] }
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
  tracing:
    lambda: true
    apiGateway: true
  apiGateway:
    minimumCompressionSize: 1024
    shouldStartNameWithService: true
  httpApi:
    metrics: true
    cors:
      allowedOrigins: ${self:custom.env.allowedOrigins}
      allowedHeaders:
        - Authorization
        - Content-Type
        - Idempotency-Key
        - X-Amz-Date
        - X-Amz-Security-Token
      allowedMethods:
        - OPTIONS
        - GET
        - POST
        - PATCH
  vpc:
    subnetIds: ${self:custom.env.vpc.subnetIds}
    securityGroupIds: ${self:custom.env.vpc.securityGroupIds}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - secretsmanager:GetSecretValue
          Resource: ${self:custom.env.dbSecretArn}
        - Effect: Allow
          Action:
            - sqs:SendMessage
            - sqs:SendMessageBatch
            - sqs:GetQueueUrl
          Resource: { 'Fn::GetAtt': [CalendarSyncQueue, Arn] }
        - Effect: Allow
          Action:
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
            - sqs:ChangeMessageVisibility
          Resource: { 'Fn::GetAtt': [CalendarSyncQueue, Arn] }
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: arn:aws:logs:${self:provider.region}:${aws:accountId}:log-group:/aws/lambda/${self:service}-${self:provider.stage}-*
        - Effect: Allow
          Action:
            - xray:PutTraceSegments
            - xray:PutTelemetryRecords
          Resource: '*'

package:
  individually: true
  excludeDevDependencies: true
  patterns:
    - '!tests/**'
    - '!docs/**'
    - '!**/*.md'

functions:
  leaveGetBalance:
    handler: src/handlers/leave/getBalance.handler
    events:
      - httpApi:
          method: GET
          path: /api/v1/leave/balance

  leaveListRequests:
    handler: src/handlers/leave/listRequests.handler
    events:
      - httpApi:
          method: GET
          path: /api/v1/leave/requests

  leaveCreateRequest:
    handler: src/handlers/leave/createRequest.handler
    events:
      - httpApi:
          method: POST
          path: /api/v1/leave/requests

  leaveUpdateRequest:
    handler: src/handlers/leave/updateRequest.handler
    events:
      - httpApi:
          method: PATCH
          path: /api/v1/leave/requests/{id}

  attendanceGetLogs:
    handler: src/handlers/attendance/getLogs.handler
    events:
      - httpApi:
          method: GET
          path: /api/v1/attendance

  attendanceClockIn:
    handler: src/handlers/attendance/clockIn.handler
    provisionedConcurrency: ${self:custom.functionOverrides.attendanceClockIn.provisionedConcurrency, null}
    events:
      - httpApi:
          method: POST
          path: /api/v1/attendance/clock-in

  attendanceClockOut:
    handler: src/handlers/attendance/clockOut.handler
    provisionedConcurrency: ${self:custom.functionOverrides.attendanceClockOut.provisionedConcurrency, null}
    events:
      - httpApi:
          method: POST
          path: /api/v1/attendance/clock-out

  integrationsMsGraphSync:
    handler: src/handlers/integrations/msgraphSyncEnqueue.handler
    timeout: 10
    events:
      - httpApi:
          method: POST
          path: /api/v1/integrations/msgraph/sync

  reportsLeaveSummary:
    handler: src/handlers/reports/leaveSummary.handler
    timeout: 20
    events:
      - httpApi:
          method: GET
          path: /api/v1/reports/leave-summary

  healthz:
    handler: src/handlers/healthz.handler
    timeout: 5
    memorySize: 256
    events:
      - httpApi:
          method: GET
          path: /healthz

  msGraphSyncWorker:
    handler: src/handlers/integrations/msgraphSyncWorker.handler
    maximumRetryAttempts: 2
    events:
      - sqs:
          arn: { 'Fn::GetAtt': [CalendarSyncQueue, Arn] }
          batchSize: 5

resources:
  Resources:
    CalendarSyncDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-calendar-sync-dlq
        MessageRetentionPeriod: 1209600 # 14 days

    CalendarSyncQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-calendar-sync
        VisibilityTimeout: ${self:custom.env.calendarSync.visibilityTimeout, 60}
        RedrivePolicy:
          deadLetterTargetArn: { 'Fn::GetAtt': [CalendarSyncDLQ, Arn] }
          maxReceiveCount: ${self:custom.env.calendarSync.maxReceiveCount, 3}

    ApiErrorRateAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-error-rate
        Namespace: AWS/ApiGateway
        MetricName: 5XXError
        Dimensions:
          - Name: ApiName
            Value: ${self:service}-${self:provider.stage}
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 1
        Threshold: 5
        ComparisonOperator: GreaterThanOrEqualToThreshold
        TreatMissingData: notBreaching

    ApiLatencyAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-latency
        Namespace: AWS/ApiGateway
        MetricName: Latency
        Dimensions:
          - Name: ApiName
            Value: ${self:service}-${self:provider.stage}
        Statistic: Average
        Period: 300
        EvaluationPeriods: 1
        Threshold: 300
        ComparisonOperator: GreaterThanOrEqualToThreshold
        TreatMissingData: notBreaching

    CalendarSyncDLQAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-calendar-sync-dlq-depth
        Namespace: AWS/SQS
        MetricName: ApproximateNumberOfMessagesVisible
        Dimensions:
          - Name: QueueName
            Value: { 'Fn::GetAtt': [CalendarSyncDLQ, QueueName] }
        Statistic: Average
        Period: 300
        EvaluationPeriods: 1
        Threshold: 1
        ComparisonOperator: GreaterThanOrEqualToThreshold
        TreatMissingData: notBreaching

  Outputs:
    HttpApiInvokeUrl:
      Description: Invoke URL for the HTTP API
      Value:
        Fn::Join:
          - ''
          - - https://
            - { Ref: HttpApi }
            - .execute-api.
            - ${self:provider.region}
            - .amazonaws.com
    CalendarSyncQueueArn:
      Description: ARN of the calendar sync SQS queue
      Value: { 'Fn::GetAtt': [CalendarSyncQueue, Arn] }

